<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste de Integra√ß√£o - API Nuvemshop</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .test-success {
        border-left: 4px solid #28a745;
      }
      .test-error {
        border-left: 4px solid #dc3545;
      }
      .test-info {
        border-left: 4px solid #17a2b8;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-connected {
        background-color: #28a745;
      }
      .status-disconnected {
        background-color: #dc3545;
      }
      .status-loading {
        background-color: #ffc107;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>üß™ Teste de Integra√ß√£o - API Nuvemshop</h1>
        <p>Verifique se a integra√ß√£o com a API est√° funcionando corretamente</p>
      </header>

      <main class="main-content">
        <!-- Status da API -->
        <section class="test-section">
          <h2>üìä Status da API</h2>
          <div class="d-flex align-items-center mb-3">
            <span class="status-indicator" id="apiStatusIndicator"></span>
            <span id="apiStatusText">Verificando...</span>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="testApiConnection()">
              Testar Conex√£o
            </button>
            <button class="btn btn-secondary" onclick="showApiConfig()">
              Ver Configura√ß√µes
            </button>
          </div>
        </section>

        <!-- Teste de Cupons -->
        <section class="test-section">
          <h2>üé´ Teste de Cupons</h2>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="listCoupons()">
              Listar Cupons
            </button>
            <button class="btn btn-success" onclick="createTestCoupon()">
              Criar Cupom de Teste
            </button>
            <button class="btn btn-warning" onclick="deleteTestCoupons()">
              Limpar Cupons de Teste
            </button>
          </div>
          <div id="couponsResult" class="test-result" style="display: none;"></div>
        </section>

        <!-- Teste de Pedidos -->
        <section class="test-section">
          <h2>üì¶ Teste de Pedidos</h2>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="listOrders()">
              Listar Pedidos
            </button>
            <button class="btn btn-info" onclick="getRecentOrders()">
              Pedidos Recentes
            </button>
          </div>
          <div id="ordersResult" class="test-result" style="display: none;"></div>
        </section>

        <!-- Teste de Produtos -->
        <section class="test-section">
          <h2>üõçÔ∏è Teste de Produtos</h2>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="listProducts()">
              Listar Produtos
            </button>
            <button class="btn btn-info" onclick="getProductCount()">
              Contar Produtos
            </button>
          </div>
          <div id="productsResult" class="test-result" style="display: none;"></div>
        </section>

        <!-- Informa√ß√µes da Loja -->
        <section class="test-section">
          <h2>üè™ Informa√ß√µes da Loja</h2>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="getStoreInfo()">
              Obter Informa√ß√µes
            </button>
          </div>
          <div id="storeResult" class="test-result" style="display: none;"></div>
        </section>

        <!-- Log de Testes -->
        <section class="test-section">
          <h2>üìù Log de Testes</h2>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-secondary" onclick="clearLog()">
              Limpar Log
            </button>
            <button class="btn btn-info" onclick="exportLog()">
              Exportar Log
            </button>
          </div>
          <div id="testLog" class="test-result test-info"></div>
        </section>
      </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script>
      // Vari√°veis globais
      let testLog = [];

      // Fun√ß√£o para adicionar log
      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        testLog.push({ message: logEntry, type });
        
        const logElement = document.getElementById('testLog');
        logElement.textContent = testLog.map(entry => entry.message).join('\n');
        logElement.scrollTop = logElement.scrollHeight;
      }

      // Fun√ß√£o para mostrar resultado
      function showResult(elementId, data, type = 'info') {
        const element = document.getElementById(elementId);
        element.style.display = 'block';
        element.className = `test-result test-${type}`;
        element.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
      }

      // Fun√ß√£o para atualizar status da API
      function updateApiStatus(connected, message = '') {
        const indicator = document.getElementById('apiStatusIndicator');
        const text = document.getElementById('apiStatusText');
        
        if (connected) {
          indicator.className = 'status-indicator status-connected';
          text.textContent = `Conectado${message ? ` - ${message}` : ''}`;
        } else {
          indicator.className = 'status-indicator status-disconnected';
          text.textContent = `Desconectado${message ? ` - ${message}` : ''}`;
        }
      }

      // Testar conex√£o com a API
      async function testApiConnection() {
        try {
          updateApiStatus(false, 'Testando...');
          addLog('Testando conex√£o com a API...');
          
          if (!isApiConfigured()) {
            throw new Error('API n√£o configurada');
          }

          const response = await fetch(getApiUrl('/store'), {
            headers: getApiHeaders()
          });

          if (response.ok) {
            const storeData = await response.json();
            updateApiStatus(true, storeData.name);
            addLog(`‚úÖ Conex√£o bem-sucedida! Loja: ${storeData.name}`);
            showResult('storeResult', storeData, 'success');
          } else {
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          updateApiStatus(false, error.message);
          addLog(`‚ùå Erro na conex√£o: ${error.message}`);
        }
      }

      // Listar cupons
      async function listCoupons() {
        try {
          addLog('Listando cupons...');
          const coupons = await nuvemshopAPI.listDiscountCoupons();
          addLog(`‚úÖ Encontrados ${coupons.length} cupons`);
          showResult('couponsResult', coupons, 'success');
        } catch (error) {
          addLog(`‚ùå Erro ao listar cupons: ${error.message}`);
          showResult('couponsResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Criar cupom de teste
      async function createTestCoupon() {
        try {
          const testCode = `TESTE${Date.now()}`;
          addLog(`Criando cupom de teste: ${testCode}`);
          
          const couponData = {
            name: testCode,
            code: testCode,
            value: 10,
            type: 'percent',
            minimum_amount: 50
          };

          const coupon = await nuvemshopAPI.createDiscountCoupon(couponData);
          addLog(`‚úÖ Cupom criado com sucesso: ${coupon.code}`);
          showResult('couponsResult', coupon, 'success');
        } catch (error) {
          addLog(`‚ùå Erro ao criar cupom: ${error.message}`);
          showResult('couponsResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Deletar cupons de teste
      async function deleteTestCoupons() {
        try {
          addLog('Buscando cupons de teste...');
          const coupons = await nuvemshopAPI.listDiscountCoupons();
          const testCoupons = coupons.filter(c => c.code.startsWith('TESTE'));
          
          addLog(`Encontrados ${testCoupons.length} cupons de teste`);
          
          for (const coupon of testCoupons) {
            try {
              await nuvemshopAPI.deleteDiscountCoupon(coupon.id);
              addLog(`‚úÖ Cupom deletado: ${coupon.code}`);
            } catch (error) {
              addLog(`‚ùå Erro ao deletar cupom ${coupon.code}: ${error.message}`);
            }
          }
          
          showResult('couponsResult', `Deletados ${testCoupons.length} cupons de teste`, 'success');
        } catch (error) {
          addLog(`‚ùå Erro ao deletar cupons: ${error.message}`);
          showResult('couponsResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Listar pedidos
      async function listOrders() {
        try {
          addLog('Listando pedidos...');
          const orders = await nuvemshopAPI.listOrders({ limit: 10 });
          addLog(`‚úÖ Encontrados ${orders.length} pedidos`);
          showResult('ordersResult', orders, 'success');
        } catch (error) {
          addLog(`‚ùå Erro ao listar pedidos: ${error.message}`);
          showResult('ordersResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Obter pedidos recentes
      async function getRecentOrders() {
        try {
          addLog('Buscando pedidos recentes...');
          const orders = await nuvemshopAPI.listOrders({ 
            limit: 5,
            status: 'paid'
          });
          addLog(`‚úÖ Encontrados ${orders.length} pedidos pagos`);
          showResult('ordersResult', orders, 'success');
        } catch (error) {
          addLog(`‚ùå Erro ao buscar pedidos: ${error.message}`);
          showResult('ordersResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Listar produtos
      async function listProducts() {
        try {
          addLog('Listando produtos...');
          const products = await nuvemshopAPI.listProducts({ limit: 10 });
          addLog(`‚úÖ Encontrados ${products.length} produtos`);
          showResult('productsResult', products, 'success');
        } catch (error) {
          addLog(`‚ùå Erro ao listar produtos: ${error.message}`);
          showResult('productsResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Contar produtos
      async function getProductCount() {
        try {
          addLog('Contando produtos...');
          const products = await nuvemshopAPI.listProducts({ limit: 100 });
          addLog(`‚úÖ Total de produtos: ${products.length}`);
          showResult('productsResult', { total: products.length, products: products.slice(0, 5) }, 'success');
        } catch (error) {
          addLog(`‚ùå Erro ao contar produtos: ${error.message}`);
          showResult('productsResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Obter informa√ß√µes da loja
      async function getStoreInfo() {
        try {
          addLog('Obtendo informa√ß√µes da loja...');
          const response = await fetch(getApiUrl('/store'), {
            headers: getApiHeaders()
          });
          
          if (response.ok) {
            const storeData = await response.json();
            addLog(`‚úÖ Informa√ß√µes obtidas: ${storeData.name}`);
            showResult('storeResult', storeData, 'success');
          } else {
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          addLog(`‚ùå Erro ao obter informa√ß√µes da loja: ${error.message}`);
          showResult('storeResult', `Erro: ${error.message}`, 'error');
        }
      }

      // Mostrar configura√ß√µes da API
      function showApiConfig() {
        const config = {
          storeId: NUVERMSHOP_CONFIG.STORE_ID,
          accessToken: NUVERMSHOP_CONFIG.ACCESS_TOKEN ? '***' + NUVERMSHOP_CONFIG.ACCESS_TOKEN.slice(-4) : 'N√£o configurado',
          baseUrl: NUVERMSHOP_CONFIG.BASE_URL,
          isConfigured: isApiConfigured()
        };
        
        showResult('storeResult', config, 'info');
        addLog('Configura√ß√µes da API exibidas');
      }

      // Limpar log
      function clearLog() {
        testLog = [];
        document.getElementById('testLog').textContent = '';
        addLog('Log limpo');
      }

      // Exportar log
      function exportLog() {
        const logText = testLog.map(entry => entry.message).join('\n');
        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `api-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        addLog('Log exportado');
      }

      // Inicializa√ß√£o
      document.addEventListener('DOMContentLoaded', () => {
        addLog('P√°gina de teste carregada');
        
        // Verificar configura√ß√£o da API
        if (isApiConfigured()) {
          addLog('‚úÖ API configurada');
          updateApiStatus(true, 'Configurada');
        } else {
          addLog('‚ö†Ô∏è API n√£o configurada');
          updateApiStatus(false, 'N√£o configurada');
        }
      });
    </script>
  </body>
</html>
